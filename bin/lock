#! /bin/bash

refocus_fullscreen_nodes() {
	while [ -e "$(pgrep -x permafocus)" ]; do sleep 1; done

	for NODE in ${FULLSCREEN_NODES}; do
		bspc node ${NODE} -t fullscreen
	done
}

if [ $(pgrep -x lock | wc -l) -gt 2 ]; then
	# Starting multiple screen lock instances may cause unintended side effects
	exit 0
fi

FOCUSED_MONITOR=$(bspc query -M -m)
FULLSCREEN_NODES=$(bspc query -N -n any.fullscreen)

bspc monitor -f 1
~/.local/kitty.app/bin/kitty \
		-c ~/.config/kitty/lock_screen.conf \
		-- ~/bin/lockscr1 &

sleep 2
PRIMARY_WINDOW=$(bspc query -N -n)

if [ -n "$(xrandr --listmonitors | grep 'DP-2')" ]; then
	bspc monitor -f 2
	~/.local/kitty.app/bin/kitty \
			-c ~/.config/kitty/lock_screen.conf \
			-- ~/bin/lockscr2 &

	sleep 2
	SECONDARY_WINDOW=$(bspc query -N -n)
fi

refocus_fullscreen_nodes &

~/bin/permafocus ${PRIMARY_WINDOW} ${SECONDARY_WINDOW}

bspc node ${PRIMARY_WINDOW} -k
bspc node ${SECONDARY_WINDOW} -k

# Kill second tty-clock
kill -9 $(ps -s $(ps -C lockscr2 -o pid=) -o pid=)

bspc monitor -f ${FOCUSED_MONITOR}
