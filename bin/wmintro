#! /bin/bash

# real windows? (there is always a pidless phantom window)
if [ "$(xdo pid $(bspc query -N) | wc -l)" -gt 0 ]; then
	echo "Please close all windows first."
	exit 1
fi

MONITORS=$(xrandr -q | grep ' connected' | wc -l)

ls ~/.config/bspwm/intro_${MONITORS}_monitors.canvas ~/.config/bspwm/intro_${MONITORS}_monitors.rules
if [ "$?" != "0" ]; then
	echo "Your number of monitors is not supported."
	exit 1
fi

bspc wm -l ~/.config/bspwm/intro_${MONITORS}_monitors.canvas
~/.config/bspwm/intro_${MONITORS}_monitors.rules

WINIT_X11_SCALE_FACTOR=1.0 alacritty -e musikbox -e -n -v 0.4 -p ~/.wmintro_audio &
sleep 0.25
MUSIKBOX_PID=$(pidof musikbox | tail -n 1)

WINIT_X11_SCALE_FACTOR=1.0 alacritty -e sh -c 'cava | lolcat' &
TERM_PIDS="${TERM_PIDS}$! "
sleep 0.25

WINIT_X11_SCALE_FACTOR=1.0 alacritty -e neo-matrix -D &
TERM_PIDS="${TERM_PIDS}$! "
sleep 0.25

PATH="${PATH}:${HOME}/bin" WINIT_X11_SCALE_FACTOR=1.0 alacritty -e slw &
TERM_PIDS="${TERM_PIDS}$! "
sleep 0.25

WINIT_X11_SCALE_FACTOR=1.0 alacritty -e tty-clock -srDB &
TERM_PIDS="${TERM_PIDS}$! "
sleep 0.25

# we want the fun stuff to be visible, it's more important than the player
if [ "${MONITORS}" -eq "1" ]; then
	bspc desktop -f 2
fi

while [ -n "$(ps -p ${MUSIKBOX_PID})" ]; do sleep 1; done

bspc rule -r *
kill ${TERM_PIDS}

bspc desktop -f 1
